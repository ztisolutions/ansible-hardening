---

  - name: 5.3.1 Ensure password creation requirements are configured (Scored)
    apt:
      name: libpam-pwquality
      state: present
    tags:
      - section5
      - section5.3
      - section5.3.1
      - lvl.1.server
      - lvl.1.workstation
      
  - name: 5.3.1 Ensure password creation requirements are configured (Scored)
    lineinfile:
      name: /etc/security/pwquality.conf
      regexp: '^{{item.name}}'
      line: '{{item.name}}={{item.value}}'
    with_items:
      - { name: 'minlen' , value: '14' }
      - { name: 'dcredit' , value: '-1' }
      - { name: 'ucredit' , value: '-1' }
      - { name: 'ocredit' , value: '-1' }
      - { name: 'lcredit' , value: '-1' }
    tags:
      - section5
      - section5.3
      - section5.3.1
      - lvl.1.server
      - lvl.1.workstation
      
  - name: 5.3.1 Ensure password creation requirements are configured (Scored)
    lineinfile:
      name: /etc/pam.d/common-password
      regexp: 'pam_pwquality.so'
      line: 'password        requisite                       pam_pwquality.so try_first_pass retry=3'
    tags:
      - section5
      - section5.3
      - section5.3.1
      - lvl.1.server
      - lvl.1.workstation
      
  - name: 5.3.2 Ensure lockout for failed password attempts is configured (Not Scored)
    lineinfile:
      name: /etc/pam.d/common-auth
      regexp: 'pam_tally2'
      line: 'auth required pam_tally2.so onerr=fail audit silent deny=5 unlock_time=900'
    tags:
      - section5
      - section5.3
      - section5.3.2
      - lvl.1.server
      - lvl.1.workstation
      - not.scored
      
  - name: 5.3.3 & 5.3.4 Ensure password reuse is limited & using SHA-512 hashing algorithm (Scored)
    lineinfile:
      name: /etc/pam.d/common-password
      regexp: '^\bpassword\b.*\bpam_unix\.so\b.*$'
      line: 'password required pam_unix.so remember=5 try_first_pass obscure sha512 try_first_pass'
    tags:
      - section5
      - section5.3
      - section5.3.3
      - section5.3.4
      - lvl.1.server
      - lvl.1.workstation
